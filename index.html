<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giải Hệ Phương Trình - Phương Pháp Gauss-Seidel</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.7.0/math.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --background-color: #f8f9fa;
            --text-color: #333;
            --border-color: #ddd;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
        }

        body {
            background: linear-gradient(180deg, #4FC3F7, #94df97, #FFFFFF);
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: var(--text-color);
            opacity: 1;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;

            /* THÊM CÁC DÒNG SAU: */
            min-height: 100vh;
            /* Đảm bảo body cao ít nhất bằng chiều cao màn hình */
            box-sizing: border-box;
            /* Quan trọng: để padding và border được tính vào tổng chiều cao/rộng */
        }

        body.page-fade-out {
            opacity: 0;
            transform: translateY(30px);
        }

        h1,
        h2,
        h3 {
            color: #2c3e50;
            font-weight: 500;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            position: relative;
        }

        h1::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background-color: var(--secondary-color);
        }

        .input-section {
            background-color: rgb(240, 245, 255);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .input-group {
            flex: 1;
            margin-bottom: 22px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        input {
            /* Kiểu chung cho input */
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
            height: 42px;
            /* Đồng bộ chiều cao với custom input */
        }

        input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        #equationsInputs table td input[type="number"] {
            min-width: 80px;
        }

        button {
            /* Kiểu chung cho button, không áp dụng cho nút tăng giảm đặc biệt */
            background: linear-gradient(to right, #0D47A1, #0288D1, #4FC3F7);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 25px auto;
            transition: all 0.3s;
            width: 220px;
            font-weight: 500;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background: linear-gradient(to right, rgba(0, 123, 255, 0.8), rgba(0, 196, 180, 0.2));
            transform: translateY(-2px);
        }

        /* ===== START: CSS FOR CUSTOM NUMBER INPUT (Số phương trình) ===== */
        .custom-number-input {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color);
            /* Viền ngoài cho cả cụm */
            border-radius: 8px;
            /* Bo góc cho cả cụm */
            overflow: hidden;
            /* Để bo góc các nút bên trong hoạt động đúng */
            width: -webkit-fit-content;
            width: -moz-fit-content;
            width: fit-content;
            background-color: #fff;
            /* Nền cho cả cụm */
            margin-left: auto;
            /* THÊM DÒNG NÀY */
            margin-right: auto;
            /* THÊM DÒNG NÀY */
            margin-top: 5px;
        }

        .custom-number-input input[readonly]#numEquations {
            /* Áp dụng cụ thể cho input này */
            width: 650px;
            /* Độ rộng của ô hiển thị số */
            text-align: center;
            border: none;
            /* Bỏ viền riêng của input */
            padding: 10px 5px;

            font-family: 'Times New Roman';
            font-size: 25px;
            font-weight: bold;
            color: rgb(0, 35, 124);

            background-color: transparent;
            /* Nền trong suốt */
            pointer-events: none;
            height: 40px;
            /* Chiều cao bằng với nút */
            box-shadow: none !important;
            border-left: 1px solid var(--border-color);
            /* Thêm viền trái */
            border-right: 1px solid var(--border-color);
            /* Thêm viền phải */
            margin: 0;
            /* Reset margin */
            border-radius: 0;
            /* Bỏ bo góc riêng */
        }

        .custom-number-input .num-equations-btn {
            /* Kiểu cho nút tăng/giảm */
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            line-height: 40px;
            text-align: center;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            /* Bỏ bo góc riêng để container kiểm soát */
            margin-left: 15px;
            margin-right: 15px;
        }

        .custom-number-input .num-equations-btn:hover {
            background-color: var(--secondary-color);
        }

        .custom-number-input .num-equations-btn:active {
            transform: scale(0.92);
        }

        /* Không cần bo góc riêng cho nút nữa nếu custom-number-input đã có overflow:hidden và border-radius */
        /* #decrementNumEquations { } */
        /* #incrementNumEquations { } */
        /* ===== END: CSS FOR CUSTOM NUMBER INPUT ===== */

        .result-section {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-top: 25px;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.7s ease-out, transform 0.7s ease-out;
            display: none;
        }

        .result-section.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .result-title {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
            margin-top: 0;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 25px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        th {
            background-color: var(--primary-color);
            color: rgb(0, 0, 0);
            padding: 12px 15px;
            text-align: center;
            font-weight: 500;
        }

        td {
            padding: 10px 15px;
            text-align: center;
            border: 1px solid #eee;
            background-color: white;
        }

        tr:nth-child(even) td {
            background-color: var(--background-color);
        }

        .math-formula {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--primary-color);
        }

        .step {
            margin-bottom: 25px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        #equationsDisplay,
        #solutionExpressions {
            max-height: 400px;
            overflow-y: auto;
        }

        #equationsInputs table thead th {
            background: linear-gradient(270deg, #4FC3F7, #FFFFFF);
        }

        .final-result {
            background-color: #e8f4fc;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            margin-top: 25px;
        }

        .error {
            color: var(--error-color);
            background-color: #fde8e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--error-color);
        }

        .success {
            font-weight: bold;
            color: var(--success-color);
            background-color: #e8f8f5;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--success-color);
        }

        .number-cell {
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
            padding-right: 15px;
        }

        .mjx-chtml {
            font-size: 1.1em !important;
        }

        .success-box {
            background-color: #e8f8f5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--success-color);
        }

        .success-box h3 {
            color: var(--success-color);
            margin-top: 0;
        }

        .input-row {
            display: flex;
            gap: 20px;
            margin-top: 1px;
            align-items: center;
            /* Căn chỉnh các item trong input-row */
        }

        .data-points {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .data-point {
            flex: 1;
            min-width: 150px;
        }

        .data-table {
            width: 100%;
            margin: 20px 0;
        }

        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: center;
        }

        .equation-input {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            color: black;
        }

        .equation-input span {
            white-space: nowrap;
            margin: 0 2px;
            line-height: 1;
        }

        .equation-input input {
            width: 80px;
            padding: 10px;
            text-align: center;
        }

        .matrix-input {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
            margin-bottom: 10px;
        }

        .matrix-input input {
            width: 100%;
            box-sizing: border-box;
        }

        .section-title {
            background-color: #2c3e50;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            margin-top: 30px;
            margin-bottom: 10px;
        }

        .final-result-title {
            color: #2c3e50;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .result-variables {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 5px 0;
            padding: 0;
            flex-wrap: wrap;
        }

        .result-variable {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin: 10px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05), 0 0 10px rgba(216, 216, 216, 0.5);
            transition: transform 0.3s, box-shadow 0.3s;
            flex: 1 1 120px;
            max-width: 200px;
        }

        .result-variable:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .result-variable-name {
            font-size: 1.9em;
            color: #2a4e86;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .result-variable-value {
            font-size: 1.4em;
            color: #2c3e50;
            font-family: 'Cambria Math', monospace;
            word-break: break-all;
        }

        .result-matrix {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 40px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05), 0 0 10px rgba(216, 216, 216, 0.5);
            border-left: 5px solid #3498db;
        }

        .result-divfinal {
            background: rgb(96, 254, 96);
            border-radius: 8px;
            padding: 20px;
            margin-top: 40px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .scrollable-table {
            max-height: 300px;
            overflow-y: auto;
            display: block;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 15px 0;
        }

        .scrollable-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .scrollable-table th {
            position: sticky;
            top: 0;
            background: #1e8fff;
            color: #e8f4fc;
            z-index: 10;
            font-size: 20px;
        }

        .matrix-input-table-container {
            overflow-x: auto;
        }

        .mobile-equation-title,
        .mobile-input-label {
            display: none;
        }

        @media (max-width: 768px) {
            .matrix-input-table-container {
                max-height: 450px;
                overflow-y: auto;
                overflow-x: hidden;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                padding: 10px;
            }

            #equationsInputs table {
                display: block;
                width: 100%;
                border: none;
                box-shadow: none;
                overflow: visible;
                margin: 0;
            }

            #equationsInputs thead {
                display: none;
            }

            #equationsInputs tbody {
                display: block;
                width: 100%;
            }

            #equationsInputs tr {
                display: block;
                width: 100%;
                margin-bottom: 15px;
                padding: 15px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background-color: #fdfdfd;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            }

            #equationsInputs tr:nth-child(even) td {
                background-color: transparent;
            }


            #equationsInputs td {
                display: block;
                width: 100% !important;
                box-sizing: border-box;
                padding: 8px 0;
                border: none;
                text-align: left;
                background-color: transparent !important;
            }

            #equationsInputs td input[type="number"] {
                width: 100% !important;
                min-width: 0 !important;
                margin-top: 4px;
            }

            .mobile-equation-title {
                display: block;
                font-weight: bold;
                margin-bottom: 12px;
                color: var(--primary-color);
                font-size: 1.1em;
            }

            .mobile-input-label {
                display: block;
                margin-bottom: 3px;
                font-weight: normal;
                color: #333;
                font-size: 0.95em;
            }

            .custom-number-input input[readonly]#numEquations {
                width: 100%;
                font-size: 20px;
            }

            .custom-number-input .num-equations-btn {
                width: 70px;
                height: 40px;
            }
        }


        @media (max-width: 768px) {

            .input-row,
            .data-points {
                flex-direction: column;
                gap: 15px;
            }

            .scrollable-table {
                /* max-height: 200px; */
                /* Gỡ bỏ hoặc điều chỉnh nếu cần */
                font-size: 10px;
                /* Nên kiểm tra lại kích thước này có quá nhỏ không */
            }

            .math-formula {
                font-size: 10px;
                /* Nên kiểm tra lại kích thước này */
            }

            #equationsDisplay,
            #solutionExpressions {
                max-height: 300px;
            }

            .equation-input {
                flex-wrap: wrap;
            }

            .equation-input>span,
            .equation-input>input {
                flex-basis: calc(25% - 10px);
                min-width: 50px;
            }

            .equation-input input {
                width: auto;
                padding: 8px;
                font-size: 0.9em;
            }

            .result-variables {
                gap: 10px;
            }

            .result-variable {
                min-width: 100px;
                flex-basis: calc(50% - 20px);
                max-width: calc(50% - 20px);
                padding: 10px;
                margin: 5px;
            }

            .result-variable-name {
                font-size: 1.4em;
            }

            .result-variable-value {
                font-size: 1.1em;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.4em;
            }

            body>button:first-of-type {
                width: 95% !important;
                font-size: 0.9em;
                padding: 10px;
            }

            .input-section {
                padding: 10px;
            }

            #equationsDisplay,
            #solutionExpressions {
                max-height: 250px;
            }

            .equation-input {
                gap: 5px;
            }

            .equation-input>span,
            .equation-input>input {
                flex-basis: calc(50% - 8px);
            }

            .equation-input input {
                font-size: 0.85em;
                padding: 6px;
            }

            button {
                /* Áp dụng cho nút chung, không phải nút tăng giảm */
                width: 90%;
                font-size: 0.9em;
            }

            .result-variables {
                flex-direction: column;
                align-items: center;
            }

            .result-variable {
                flex-basis: 80%;
                max-width: 280px;
                padding: 10px;
                margin: 8px 0;
            }

            .result-variable-name {
                font-size: 1.3em;
            }

            .result-variable-value {
                font-size: 1em;
            }

            .section-title {
                font-size: 0.9em;
                padding: 6px 10px;
            }
        }
    </style>
</head>

<body>
    <!-- <button onclick="goToHomeWithTransition()"
        style="width: 400px; height: 50px; text-align: center; background: linear-gradient(135deg, #00B4DB, #0083B0, #00FF7F);">Home</button> -->
    <h1>Giải Hệ Phương Trình - Phương Pháp Gauss-Seidel</h1>

    <div class="input-section">
        <div class="input-row">
            <div class="input-group">
                <label for="numEquations">Số phương trình cho hệ:</label>
                <div class="custom-number-input">
                    <button type="button" class="num-equations-btn" id="decrementNumEquations"
                        aria-label="Giảm số phương trình">-</button>
                    <input type="text" id="numEquations" value="4" readonly aria-live="polite">
                    <button type="button" class="num-equations-btn" id="incrementNumEquations"
                        aria-label="Tăng số phương trình">+</button>
                </div>
            </div>
        </div>
        <button id="setupBtn">Thiết lập hệ phương trình</button>
    </div>

    <div id="equationsSetup" class="input-section" style="display: none;">
        <h2>Nhập hệ phương trình</h2>
        <div id="equationsInputs"></div>
        <div class="input-row">
            <div class="input-group">
                <label for="floatpoint">Số chữ số sau dấu phẩy (cho kết quả):</label>
                <input type="number" id="floatpoint" min="0" value="6" max="15">
            </div>
            <div class="input-group">
                <label for="numIterations">Số bước lặp (n):</label>
                <input type="number" id="numIterations" min="1" max="100" value="4">
            </div>
        </div>
        <button id="calculateBtn">Giải hệ phương trình</button>
    </div>

    <div id="result" class="result-section">
        <div class="calc-success-msg"
            style="background-color: #24ff7f; color: white; padding: 8px 15px; border-radius: 4px; margin-top: 10px; display: none;">
            Tính toán thành công ✅
        </div>
        <h2 class="result-title">Kết quả tính toán</h2>

        <div id="equationsDisplay" class="step"></div>
        <div id="solutionExpressions" class="step"></div>
        <div id="matrixB" class="step"></div>
        <div id="normB" class="step"></div>
        <div id="matrixU" class="step"></div>
        <div id="normU" class="step"></div>
        <div id="iterationResults" class="step"></div>
        <div id="errorEstimation" class="step"></div>

        <div class="final-result">
            <div class="final-result-title">KẾT QUẢ CUỐI CÙNG</div>
            <div class="result-divfinal">
                <div id="finalIterationResult" class="result-matrix"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let m = 0;
        let n = 0;
        let varNames = [];
        let A = [];
        let d = [];
        let B = [];
        let U = [];
        let normB = 0;
        let normU = 0;

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('setupBtn').addEventListener('click', setupEquations);

            // === BẮT ĐẦU CODE MỚI CHO TÍNH NĂNG NHẤN GIỮ ===
            const numEquationsInput = document.getElementById('numEquations');
            const decrementNumEqBtn = document.getElementById('decrementNumEquations');
            const incrementNumEqBtn = document.getElementById('incrementNumEquations');

            let initialTimeoutId = null;    // ID cho timeout ban đầu
            let repeatIntervalId = null;    // ID cho interval lặp lại
            const REPEAT_DELAY_INITIAL = 400; // Thời gian chờ ban đầu trước khi lặp (ms)
            const REPEAT_DELAY_INTERVAL = 50; // Thời gian giữa mỗi lần lặp (ms)

            function changeValue(amount) {
                let currentValue = parseInt(numEquationsInput.value, 10);
                if (isNaN(currentValue)) {
                    currentValue = 2; // Giá trị mặc định nếu không phải là số
                }

                let newValue = currentValue + amount;

                if (amount < 0) { // Nếu đang giảm
                    if (newValue < 2) {
                        newValue = 2; // Giữ giá trị tối thiểu là 2
                    }
                }
                // Không có giới hạn tối đa cho việc tăng

                numEquationsInput.value = newValue;
            }

            function startRepeating(amount) {
                stopRepeating(); // Xóa các timer cũ nếu có

                changeValue(amount); // Thực hiện thay đổi giá trị ngay lần đầu

                // Đặt timeout: sau REPEAT_DELAY_INITIAL ms, nếu nút vẫn được giữ, bắt đầu lặp
                initialTimeoutId = setTimeout(() => {
                    // Bắt đầu interval để lặp lại việc thay đổi giá trị
                    repeatIntervalId = setInterval(() => {
                        changeValue(amount);
                    }, REPEAT_DELAY_INTERVAL);
                }, REPEAT_DELAY_INITIAL);
            }

            function stopRepeating() {
                if (initialTimeoutId !== null) {
                    clearTimeout(initialTimeoutId);
                    initialTimeoutId = null;
                }
                if (repeatIntervalId !== null) {
                    clearInterval(repeatIntervalId);
                    repeatIntervalId = null;
                }
            }

            if (decrementNumEqBtn && incrementNumEqBtn && numEquationsInput) {
                // Sự kiện cho nút giảm (-)
                decrementNumEqBtn.addEventListener('mousedown', () => startRepeating(-1));
                decrementNumEqBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // Ngăn sự kiện click và cuộn trang trên di động
                    startRepeating(-1);
                });

                // Sự kiện cho nút tăng (+)
                incrementNumEqBtn.addEventListener('mousedown', () => startRepeating(1));
                incrementNumEqBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // Ngăn sự kiện click và cuộn trang trên di động
                    startRepeating(1);
                });

                // Hàm tiện ích để thêm các listener dừng
                const addStopListeners = (button) => {
                    button.addEventListener('mouseup', stopRepeating);
                    button.addEventListener('mouseleave', stopRepeating); // Dừng nếu chuột rời khỏi nút khi đang nhấn
                    button.addEventListener('touchend', stopRepeating);
                    button.addEventListener('touchcancel', stopRepeating);
                };

                addStopListeners(decrementNumEqBtn);
                addStopListeners(incrementNumEqBtn);
            }
            // An toàn: Dừng lặp nếu người dùng chuyển tab hoặc cửa sổ
            window.addEventListener('blur', stopRepeating);
            // === KẾT THÚC CODE MỚI ===
        });

        function goToHomeWithTransition() {
            document.body.classList.add('page-fade-out');
            setTimeout(function () {
                window.location.href = '../index.html';
            }, 300);
        }

        function froundf(value) {
            const dcdInput = document.getElementById('floatpoint');
            let dcd = dcdInput ? Math.max(0, parseInt(dcdInput.value)) : 6;
            if (isNaN(dcd) || dcd < 0) {
                dcd = 6;
            }

            if (value === 0) return '0';
            if (isNaN(value) || !isFinite(value)) return String(value);

            const factor = Math.pow(10, dcd);
            let roundedValue = Math.round(value * factor) / factor;

            if (Object.is(roundedValue, -0)) {
                roundedValue = 0;
            }

            if (roundedValue % 1 === 0) {
                return roundedValue.toString();
            } else {
                let str = roundedValue.toFixed(dcd);
                if (str.includes('.')) {
                    str = str.replace(/0+$/, '');
                    str = str.replace(/\.$/, '');
                }
                return str;
            }
        }

        function setupEquations() {
            m = parseInt(document.getElementById('numEquations').value);
            n = parseInt(document.getElementById('numIterations').value);

            if (isNaN(m) || m < 2) {
                alert('Số phương trình (m) phải là một số từ 2 trở lên.');
                return;
            }

            if (isNaN(n) || n < 1) {
                alert('Số bước lặp (n) phải là một số từ 1 đến 100.');
                return;
            }

            if (m >= 2 && m <= 4) {
                const defaultVars = ['x', 'y', 'z', 't'];
                varNames = defaultVars.slice(0, m);
            } else {
                varNames = Array.from({ length: m }, (_, i) => `x_{${i + 1}}`);
            }

            const equationsInputs = document.getElementById('equationsInputs');
            equationsInputs.innerHTML = '';

            const tableContainer = document.createElement('div');
            tableContainer.className = 'matrix-input-table-container';

            const table = document.createElement('table');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            for (let j = 0; j < m; j++) {
                const th = document.createElement('th');
                th.innerHTML = `\\(${varNames[j]}\\)`;
                headerRow.appendChild(th);
            }
            const constHeader = document.createElement('th');
            constHeader.textContent = '\\(\\text{Hằng số}\\)'; // Sửa để MathJax render
            headerRow.appendChild(constHeader);
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const sampleDataCollection = {
                2: [[2, 1, 5], [1, 3, 5]],
                3: [[20, -1, 2, 20], [1, 10, 3, 10], [1, 1, -40, 80]],
                4: [[10, 1, 0, 2, 13], [1, 10, 2, 1, 14], [2, 0, 10, 3, 15], [0, 1, 2, 10, 13]],
                5: [[10, 1, 1, 1, 1, 27], [2, 10, 1, 1, 1, 35], [2, 1, 10, 1, 1, 40], [2, 1, 1, 10, 1, 49], [2, 1, 1, 1, 10, 58]],
                6: [[15, 1, 1, 1, 1, 1, 105], [2, 16, 1, 1, 1, 1, 116], [2, 2, 17, 1, 1, 1, 127], [2, 2, 2, 18, 1, 1, 138], [2, 2, 2, 2, 19, 1, 149], [2, 2, 2, 2, 2, 20, 160]],
                7: [[21, 1, 1, 1, 1, 1, 1, 147], [2, 22, 1, 1, 1, 1, 1, 158], [2, 2, 23, 1, 1, 1, 1, 169], [2, 2, 2, 24, 1, 1, 1, 180], [2, 2, 2, 2, 25, 1, 1, 191], [2, 2, 2, 2, 2, 26, 1, 202], [2, 2, 2, 2, 2, 2, 27, 213]],
                8: [[28, 1, 1, 1, 1, 1, 1, 1, 196], [2, 29, 1, 1, 1, 1, 1, 1, 207], [2, 2, 30, 1, 1, 1, 1, 1, 218], [2, 2, 2, 31, 1, 1, 1, 1, 229], [2, 2, 2, 2, 32, 1, 1, 1, 240], [2, 2, 2, 2, 2, 33, 1, 1, 251], [2, 2, 2, 2, 2, 2, 34, 1, 262], [2, 2, 2, 2, 2, 2, 2, 35, 273]],
                9: [[36, 1, 1, 1, 1, 1, 1, 1, 1, 252], [2, 37, 1, 1, 1, 1, 1, 1, 1, 263], [2, 2, 38, 1, 1, 1, 1, 1, 1, 274], [2, 2, 2, 39, 1, 1, 1, 1, 1, 285], [2, 2, 2, 2, 40, 1, 1, 1, 1, 296], [2, 2, 2, 2, 2, 41, 1, 1, 1, 307], [2, 2, 2, 2, 2, 2, 42, 1, 1, 318], [2, 2, 2, 2, 2, 2, 2, 43, 1, 329], [2, 2, 2, 2, 2, 2, 2, 2, 44, 340]],
                10: [[45, 1, 1, 1, 1, 1, 1, 1, 1, 1, 315], [2, 46, 1, 1, 1, 1, 1, 1, 1, 1, 326], [2, 2, 47, 1, 1, 1, 1, 1, 1, 1, 337], [2, 2, 2, 48, 1, 1, 1, 1, 1, 1, 348], [2, 2, 2, 2, 49, 1, 1, 1, 1, 1, 359], [2, 2, 2, 2, 2, 50, 1, 1, 1, 1, 370], [2, 2, 2, 2, 2, 2, 51, 1, 1, 1, 381], [2, 2, 2, 2, 2, 2, 2, 52, 1, 1, 392], [2, 2, 2, 2, 2, 2, 2, 2, 53, 1, 403], [2, 2, 2, 2, 2, 2, 2, 2, 2, 54, 414]],
                11: [[55, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 385], [2, 56, 1, 1, 1, 1, 1, 1, 1, 1, 1, 396], [2, 2, 57, 1, 1, 1, 1, 1, 1, 1, 1, 407], [2, 2, 2, 58, 1, 1, 1, 1, 1, 1, 1, 418], [2, 2, 2, 2, 59, 1, 1, 1, 1, 1, 1, 429], [2, 2, 2, 2, 2, 60, 1, 1, 1, 1, 1, 440], [2, 2, 2, 2, 2, 2, 61, 1, 1, 1, 1, 451], [2, 2, 2, 2, 2, 2, 2, 62, 1, 1, 1, 462], [2, 2, 2, 2, 2, 2, 2, 2, 63, 1, 1, 473], [2, 2, 2, 2, 2, 2, 2, 2, 2, 64, 1, 484], [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 65, 495]],
                12: [[65, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 455], [2, 66, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 466], [2, 2, 67, 1, 1, 1, 1, 1, 1, 1, 1, 1, 477], [2, 2, 2, 68, 1, 1, 1, 1, 1, 1, 1, 1, 488], [2, 2, 2, 2, 69, 1, 1, 1, 1, 1, 1, 1, 499], [2, 2, 2, 2, 2, 70, 1, 1, 1, 1, 1, 1, 510], [2, 2, 2, 2, 2, 2, 71, 1, 1, 1, 1, 1, 521], [2, 2, 2, 2, 2, 2, 2, 72, 1, 1, 1, 1, 532], [2, 2, 2, 2, 2, 2, 2, 2, 73, 1, 1, 1, 543], [2, 2, 2, 2, 2, 2, 2, 2, 2, 74, 1, 1, 554], [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 75, 1, 565], [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 76, 576]]
            };
            const currentSampleData = sampleDataCollection[m] || [];

            for (let i = 0; i < m; i++) {
                const row = document.createElement('tr');
                const equationTitleDiv = document.createElement('div');
                equationTitleDiv.className = 'mobile-equation-title';
                equationTitleDiv.textContent = `Phương trình ${i + 1}:`;
                row.appendChild(equationTitleDiv);

                for (let j = 0; j < m; j++) {
                    const cell = document.createElement('td');
                    const label = document.createElement('label');
                    label.className = 'mobile-input-label';
                    label.innerHTML = `\\(${varNames[j]}\\):`;
                    cell.appendChild(label);

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.id = `a${i}${j}`;
                    input.placeholder = `a(${i + 1},${j + 1})`;
                    if (currentSampleData[i] && currentSampleData[i][j] !== undefined) {
                        input.value = currentSampleData[i][j];
                    }
                    cell.appendChild(input);
                    row.appendChild(cell);
                }

                const constCell = document.createElement('td');
                const constLabel = document.createElement('label');
                constLabel.className = 'mobile-input-label';
                constLabel.textContent = 'Hằng số (d)';
                constCell.appendChild(constLabel);

                const constInput = document.createElement('input');
                constInput.type = 'number';
                constInput.step = 'any';
                constInput.id = `d${i}`;
                constInput.placeholder = `d(${i + 1})`;
                if (currentSampleData[i] && currentSampleData[i][m] !== undefined) {
                    constInput.value = currentSampleData[i][m];
                }
                constCell.appendChild(constInput);
                row.appendChild(constCell);
                tbody.appendChild(row);
            }

            table.appendChild(tbody);
            tableContainer.appendChild(table);
            equationsInputs.appendChild(tableContainer);

            document.getElementById('equationsSetup').style.display = 'block';

            const calculateBtn = document.getElementById('calculateBtn');
            const newCalculateBtn = calculateBtn.cloneNode(true);
            calculateBtn.parentNode.replaceChild(newCalculateBtn, calculateBtn);
            newCalculateBtn.addEventListener('click', solveEquations);

            document.getElementById('equationsSetup').scrollIntoView({ behavior: 'smooth' });

            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetPromise([equationsInputs]).catch(err => console.error("MathJax typeset error on setup:", err));
            }
        }

        // ... (Các hàm solveEquations, displayEquations, v.v... giữ nguyên như trước) ...
        function solveEquations() {
            n = parseInt(document.getElementById('numIterations').value);

            const resultSection = document.getElementById('result');
            const successMsgDiv = resultSection.querySelector('.calc-success-msg');
            if (successMsgDiv) successMsgDiv.style.display = 'none';

            const oldError = resultSection.querySelector('div.error');
            if (oldError && oldError.parentElement === resultSection) oldError.remove();

            if (isNaN(n) || n < 1 || n > 100) {
                resultSection.innerHTML = `
                    <div class="error">
                        <h3>Lỗi Cấu Hình</h3>
                        <p>Số bước lặp (n) không hợp lệ: "${document.getElementById('numIterations').value}".</p>
                        <p>Vui lòng nhập một số từ 1 đến 100.</p>
                    </div>`;
                resultSection.classList.add('show');
                setTimeout(() => {
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                return;
            }

            document.getElementById('equationsDisplay').innerHTML = '';
            document.getElementById('solutionExpressions').innerHTML = '';
            document.getElementById('matrixB').innerHTML = '';
            document.getElementById('normB').innerHTML = '';
            document.getElementById('matrixU').innerHTML = '';
            document.getElementById('normU').innerHTML = '';
            document.getElementById('iterationResults').innerHTML = '';
            document.getElementById('errorEstimation').innerHTML = '';
            document.getElementById('finalIterationResult').innerHTML = '';

            try {
                A = Array(m).fill(null).map(() => Array(m).fill(0));
                d = Array(m).fill(0);

                for (let i = 0; i < m; i++) {
                    for (let j = 0; j < m; j++) {
                        const inputElement = document.getElementById(`a${i}${j}`);
                        if (!inputElement) throw new Error(`Thiếu trường nhập liệu cho a(${i + 1},${j + 1}). Vui lòng 'Thiết lập hệ phương trình' lại.`);
                        const val = inputElement.value;
                        if (val.trim() === '') throw new Error(`Giá trị cho a(${i + 1},${j + 1}) không được để trống.`);
                        A[i][j] = parseFloat(val);
                        if (isNaN(A[i][j])) throw new Error(`Giá trị không hợp lệ cho a(${i + 1},${j + 1}): "${val}".`);
                    }

                    const constInputElement = document.getElementById(`d${i}`);
                    if (!constInputElement) throw new Error(`Thiếu trường nhập liệu cho d(${i + 1}). Vui lòng 'Thiết lập hệ phương trình' lại.`);
                    const constVal = constInputElement.value;
                    if (constVal.trim() === '') throw new Error(`Giá trị cho d(${i + 1}) không được để trống.`);
                    d[i] = parseFloat(constVal);
                    if (isNaN(d[i])) throw new Error(`Giá trị không hợp lệ cho d(${i + 1}): "${constVal}".`);
                }

                if (successMsgDiv) successMsgDiv.style.display = 'block';
                resultSection.classList.remove('show');

                displayEquations();
                calculateSolutionExpressions();
                calculateMatrixB();
                calculateMatrixU();
                performIterations();

                resultSection.classList.add('show');
                setTimeout(() => {
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

                if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                    MathJax.typesetPromise([resultSection]).catch(err => console.error("MathJax error on solve:", err));
                }

            } catch (e) {
                console.error("Error in solve:", e);
                if (successMsgDiv) successMsgDiv.style.display = 'none';
                const resultTitleH2 = resultSection.querySelector('.result-title');
                const errorHTML = `<div class="error"><h3>Lỗi Tính Toán</h3><p>${e.message}</p><p>Vui lòng kiểm tra lại dữ liệu đã nhập. Nếu lỗi vẫn tiếp diễn, hãy thử 'Thiết lập hệ phương trình' lại hoặc tải lại web.</p></div>`;

                const steps = resultSection.querySelectorAll('.step, .final-result');
                steps.forEach(step => step.innerHTML = '');
                if (resultTitleH2) {
                    resultTitleH2.insertAdjacentHTML('afterend', errorHTML);
                } else {
                    resultSection.innerHTML = errorHTML + resultSection.innerHTML;
                }
                resultSection.classList.add('show');
                setTimeout(() => {
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        function displayEquations() {
            const equationsDisplay = document.getElementById('equationsDisplay');
            equationsDisplay.innerHTML = '<h3>Hệ phương trình đã nhập:</h3>';
            let systemLatex = '\\begin{cases}';
            for (let i = 0; i < m; i++) {
                let equation = '';
                let firstTerm = true;
                for (let j = 0; j < m; j++) {
                    const coeff = A[i][j];
                    if (coeff === 0) continue;

                    let sign = '';
                    if (coeff < 0) {
                        sign = firstTerm ? '-' : ' - ';
                    } else {
                        sign = firstTerm ? '' : ' + ';
                    }

                    const absCoeff = Math.abs(coeff);
                    let coeffStr = '';
                    if (absCoeff !== 1) {
                        coeffStr = froundf(absCoeff);
                    }
                    equation += `${sign}${coeffStr}${varNames[j]}`;
                    firstTerm = false;
                }
                if (equation === '' || (equation.trim() === '-' && firstTerm)) equation = '0';
                equation += ` = ${froundf(d[i])}`;
                systemLatex += equation + (i < m - 1 ? '\\\\[2ex]' : '');
            }
            systemLatex += '\\end{cases}';
            const eqDiv = document.createElement('div');
            eqDiv.className = 'math-formula';
            eqDiv.innerHTML = `\\[ ${systemLatex} \\]`;
            equationsDisplay.appendChild(eqDiv);
        }

        function calculateSolutionExpressions() {
            const solutionDiv = document.getElementById('solutionExpressions');
            solutionDiv.innerHTML = '<h3>Biểu thức nghiệm (dùng để lặp):</h3>'; // Giữ nguyên hoặc đổi tiêu đề nếu muốn
            let expressionsLatex = '\\begin{cases}';

            for (let i = 0; i < m; i++) {
                if (A[i][i] === 0) {
                    throw new Error(`Phần tử đường chéo chính A(${i + 1},${i + 1}) = 0. Không thể chia cho 0. Phương pháp Gauss-Seidel không áp dụng được.`);
                }

                let rhsString = ""; // Chuỗi chứa vế phải của phương trình
                const aii = A[i][i]; // Giá trị A[i][i] (mẫu số chung)
                const aiiStr = froundf(aii); // A[i][i] đã được làm tròn

                // Xử lý số hạng tự do: d[i] / A[i][i]
                if (d[i] !== 0) {
                    if (aii === 1) { // Nếu A[i][i] = 1
                        rhsString += froundf(d[i]);
                    } else if (aii === -1) { // Nếu A[i][i] = -1
                        rhsString += froundf(-d[i]);
                    } else {
                        rhsString += `\\frac{${froundf(d[i])}}{${aiiStr}}`;
                    }
                }
                // Nếu d[i] === 0, rhsString ban đầu sẽ rỗng, dấu của số hạng biến đầu tiên sẽ được xử lý sau

                // Xử lý các số hạng chứa biến: - (A[i][j] / A[i][i]) * varNames[j]
                for (let j = 0; j < m; j++) {
                    if (i === j) continue; // Bỏ qua biến x_i ở vế phải
                    if (A[i][j] === 0) continue; // Bỏ qua các số hạng có hệ số A[i][j] = 0

                    const aij = A[i][j]; // Hệ số A[i][j]

                    // Tính toán hệ số hiệu dụng cho varNames[j] là (-aij / aii)
                    let effectiveCoeffNum = -aij;
                    let effectiveCoeffDen = aii;

                    let termOverallSignStr; // Dấu của số hạng này ("+" hoặc "-")
                    if ((effectiveCoeffNum > 0 && effectiveCoeffDen > 0) || (effectiveCoeffNum < 0 && effectiveCoeffDen < 0)) {
                        termOverallSignStr = "+"; // Hệ số hiệu dụng là dương
                    } else {
                        termOverallSignStr = "-"; // Hệ số hiệu dụng là âm
                    }

                    // Thêm dấu vào chuỗi rhsString
                    if (rhsString === "") { // Nếu đây là số hạng đầu tiên ở vế phải
                        if (termOverallSignStr === "-") {
                            rhsString += "-"; // Bắt đầu bằng dấu trừ nếu âm
                        }
                        // Không thêm dấu "+" nếu là số hạng dương đầu tiên
                    } else { // Nếu không phải số hạng đầu tiên
                        rhsString += (termOverallSignStr === "+") ? " + " : " - ";
                    }

                    // Phần độ lớn của hệ số | A[i][j] / A[i][i] |
                    const absAij = Math.abs(aij);
                    const absAii = Math.abs(aii);

                    if (absAii === 1) { // Nếu mẫu số A[i][i] là 1 hoặc -1 (đã xử lý dấu)
                        if (absAij === 1) { // Hệ số là 1 (ví dụ 1*x_j)
                            rhsString += varNames[j];
                        } else { // Hệ số khác 1 (ví dụ 2*x_j)
                            rhsString += `${froundf(absAij)}${varNames[j]}`;
                        }
                    } else { // Nếu mẫu số A[i][i] khác 1 và -1
                        if (absAij === absAii) { // Nếu |A[i][j]| == |A[i][i]|, hệ số là 1 (ví dụ (5/5)*x_j)
                            rhsString += varNames[j];
                        } else { // Hiển thị dạng phân số
                            rhsString += `\\frac{${froundf(absAij)}}{${froundf(absAii)}}${varNames[j]}`;
                        }
                    }
                }

                if (rhsString === "") { // Trường hợp tất cả vế phải bằng 0 (ví dụ x = 0)
                    rhsString = "0";
                }

                expressionsLatex += `${varNames[i]} = ${rhsString}` + (i < m - 1 ? '\\\\[2ex]' : '');
            }
            expressionsLatex += '\\end{cases}';

            const exprDiv = document.createElement('div');
            exprDiv.className = 'math-formula';
            exprDiv.innerHTML = `\\[ ${expressionsLatex} \\]`;
            solutionDiv.appendChild(exprDiv);
        }

        function calculateMatrixB() {
            B = Array(m).fill(null).map(() => Array(m).fill(0));
            for (let i = 0; i < m; i++) {
                if (A[i][i] === 0) throw new Error(`Lỗi ma trận B: A(${i + 1},${i + 1}) = 0.`);
                for (let j = 0; j < m; j++) {
                    B[i][j] = (i === j) ? 0 : -A[i][j] / A[i][i];
                }
            }
            const matrixBdiv = document.getElementById('matrixB');
            matrixBdiv.innerHTML = '<h3>Ma trận B \\(\(X = BX + g\)\\):</h3>';
            let matrixHTML = `\\[ B = \\begin{pmatrix}`;
            for (let i = 0; i < m; i++) {
                for (let j = 0; j < m; j++) {
                    matrixHTML += ` ${froundf(B[i][j])} ${j < m - 1 ? '&' : ''}`;
                }
                matrixHTML += (i < m - 1 ? '\\\\' : '');
            }
            matrixHTML += ` \\end{pmatrix} \\]`;
            const matrixDivElement = document.createElement('div');
            matrixDivElement.className = 'math-formula';
            matrixDivElement.innerHTML = matrixHTML;
            matrixBdiv.appendChild(matrixDivElement);

            const rowSums = B.map(row => row.reduce((sum, val) => sum + Math.abs(val), 0));
            normB = rowSums.length > 0 ? Math.max(...rowSums) : 0;
            const normBdiv = document.getElementById('normB');
            normBdiv.innerHTML = `<h3>Chuẩn vô cực \\(||B||_\\infty\\)</h3>`;
            let normHTML = `\\[ ||B||_\\infty = \\max\\{${rowSums.map(x => froundf(x)).join('; ')}\\} = ${froundf(normB)} \\]`;
            normHTML += normB < 1 ? `<div class="success">Điều kiện hội tụ \\(||B||_\\infty < 1\\) thỏa mãn.</div>` : `<div class="error">Điều kiện hội tụ \\(||B||_\\infty < 1\\) KHÔNG được thỏa mãn. Kết quả có thể không hội tụ.</div>`;
            const normDiv = document.createElement('div');
            normDiv.className = 'math-formula';
            normDiv.innerHTML = normHTML;
            normBdiv.appendChild(normDiv);
        }

        function calculateMatrixU() {
            U = Array(m).fill(null).map(() => Array(m).fill(0));
            for (let i = 0; i < m; i++) {
                for (let j = i + 1; j < m; j++) {
                    U[i][j] = B[i][j];
                }
            }
            const matrixUdiv = document.getElementById('matrixU');
            matrixUdiv.innerHTML = '<h3>Ma trận U :</h3>';
            let matrixHTML = `\\[ U = \\begin{pmatrix}`;
            for (let i = 0; i < m; i++) {
                for (let j = 0; j < m; j++) {
                    matrixHTML += ` ${froundf(U[i][j])} ${j < m - 1 ? '&' : ''}`;
                }
                matrixHTML += (i < m - 1 ? '\\\\' : '');
            }
            matrixHTML += ` \\end{pmatrix} \\]`;
            const matrixDivElement = document.createElement('div');
            matrixDivElement.className = 'math-formula';
            matrixDivElement.innerHTML = matrixHTML;
            matrixUdiv.appendChild(matrixDivElement);

            const rowSums = U.map(row => row.reduce((sum, val) => sum + Math.abs(val), 0));
            normU = rowSums.length > 0 ? Math.max(...rowSums) : 0;
            const normUdiv = document.getElementById('normU');
            normUdiv.innerHTML = `<h3>Chuẩn vô cực \\(||U||_\\infty\\)</h3>`;
            const normDiv = document.createElement('div');
            normDiv.className = 'math-formula';
            normDiv.innerHTML = `\\[ ||U||_\\infty = \\max\\{${rowSums.map(x => froundf(x)).join('; ')}\\} = ${froundf(normU)} \\]`;
            normUdiv.appendChild(normDiv);
        }

        function performIterations() {
            const iterationResults = document.getElementById('iterationResults');
            iterationResults.innerHTML = '<h3>Các bước lặp </h3>';
            let x = Array(m).fill(0);
            const iterations = [x.slice()];

            for (let k = 0; k < n; k++) {
                const x_k = iterations[k];
                const x_k_plus_1 = x_k.slice();
                for (let i = 0; i < m; i++) {
                    if (A[i][i] === 0) throw new Error(`Lỗi lặp: A(${i + 1},${i + 1}) = 0.`);
                    let sum1 = 0;
                    for (let j = 0; j < i; j++) {
                        sum1 += A[i][j] * x_k_plus_1[j];
                    }
                    let sum2 = 0;
                    for (let j = i + 1; j < m; j++) {
                        sum2 += A[i][j] * x_k[j];
                    }
                    x_k_plus_1[i] = (d[i] - sum1 - sum2) / A[i][i];
                }
                iterations.push(x_k_plus_1.slice());
            }

            const tableDiv = document.createElement('div');
            tableDiv.className = 'scrollable-table';
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const headerRow = document.createElement('tr');
            const stepHeader = document.createElement('th');
            stepHeader.innerHTML = '\\(k\\)';
            headerRow.appendChild(stepHeader);
            for (let j = 0; j < m; j++) {
                const varHeader = document.createElement('th');
                varHeader.innerHTML = `\\(${varNames[j]}\\)`;
                headerRow.appendChild(varHeader);
            }
            thead.appendChild(headerRow);
            table.appendChild(thead);

            for (let k = 0; k < iterations.length; k++) {
                const row = document.createElement('tr');
                const stepCell = document.createElement('td');
                stepCell.innerHTML = `\\(${k}\\)`;
                row.appendChild(stepCell);
                for (let j = 0; j < m; j++) {
                    const cell = document.createElement('td');
                    cell.innerHTML = `\\(${froundf(iterations[k][j])}\\)`;
                    row.appendChild(cell);
                }
                tbody.appendChild(row);
            }
            table.appendChild(tbody);
            tableDiv.appendChild(table);
            iterationResults.appendChild(tableDiv);

            const errorDiv = document.getElementById('errorEstimation');
            errorDiv.innerHTML = '';

            const errorTitle = document.createElement('h3');
            errorTitle.textContent = 'Đánh giá sai số';
            errorDiv.appendChild(errorTitle);

            let errorContent = '';
            if (normB < 1) {
                if (n > 0 && iterations.length > 1 && iterations[0] && iterations[1]) {
                    const x1_minus_x0_diffs = iterations[1].map((val, idx) => Math.abs(val - iterations[0][idx]));
                    const norm_x1_minus_x0 = x1_minus_x0_diffs.length > 0 ? Math.max(...x1_minus_x0_diffs) : 0;
                } else {
                    // errorContent += `<h4>Sai số tiên nghiệm:</h4><p>Không đủ dữ liệu lặp (cần X^(0) và X^(1)) để tính.</p>`;
                }

                if (n > 0 && iterations.length >= 2 && iterations[n] && iterations[n - 1]) {
                    const x_n_vals = iterations[n];
                    const x_n_minus_1_vals = iterations[n - 1];
                    const maxDiff_apost_vals = x_n_vals.map((val, idx) => Math.abs(val - x_n_minus_1_vals[idx]));
                    const maxDiff_apost = maxDiff_apost_vals.length > 0 ? Math.max(...maxDiff_apost_vals) : 0;
                    const error_aposteriori_normU = (normU / (1 - normB)) * maxDiff_apost;

                    errorContent += `<div class="math-formula">\\[ ||X^{(${n})} - X^{(*)}||_\\infty \\leq \\frac{||U||_\\infty}{1 - ||B||_\\infty} ||X^{(${n})} - X^{(${n - 1})}||_\\infty \\]
                        \\[ \\leq \\frac{${froundf(normU)}}{1-${froundf(normB)}} \\times ${froundf(maxDiff_apost)} \\approx ${froundf(error_aposteriori_normU)} \\]</div>`;
                } else {
                    errorContent += `<h4>Sai số hậu nghiệm:</h4><p>Không đủ dữ liệu lặp (cần ít nhất X^(n) và X^(n-1) với n > 0) để tính.</p>`;
                }
            } else {
                errorContent += `<p>Không thể áp dụng các công thức đánh giá sai số chuẩn vì \\(||B||_\\infty \\ge 1\\). Phương pháp có thể không hội tụ.</p>`;
                if (n > 0 && iterations.length >= 2 && iterations[n] && iterations[n - 1]) {
                    const x_n_vals = iterations[n];
                    const x_n_minus_1_vals = iterations[n - 1];
                    const maxDiff_apost_vals = x_n_vals.map((val, idx) => Math.abs(val - x_n_minus_1_vals[idx]));
                    const maxDiff_apost = maxDiff_apost_vals.length > 0 ? Math.max(...maxDiff_apost_vals) : 0;
                    errorContent += `<p>Chênh lệch giữa 2 lần lặp cuối \\(||X^{(${n})} - X^{(${n - 1})}||_\\infty = ${froundf(maxDiff_apost)}\\)</p>`
                }
            }
            errorDiv.innerHTML += errorContent;

            const finalResultDiv = document.getElementById('finalIterationResult');
            finalResultDiv.innerHTML = `<h4>Nghiệm xấp xỉ \\(X^{(${n})}\\) sau ${n} bước lặp:</h4>`;
            const resultVarsContainer = document.createElement('div');
            resultVarsContainer.className = 'result-variables';
            const finalSolution = iterations[n];
            if (finalSolution) {
                for (let i = 0; i < m; i++) {
                    const varDiv = document.createElement('div');
                    varDiv.className = 'result-variable';
                    varDiv.innerHTML = `
                        <div class="result-variable-name">\\(${varNames[i]}\\)</div>
                        <div class="result-variable-value">${froundf(finalSolution[i])}</div>
                    `;
                    resultVarsContainer.appendChild(varDiv);
                }
            } else {
                resultVarsContainer.innerHTML = "<p>Không có kết quả cuối cùng để hiển thị.</p>";
            }
            finalResultDiv.appendChild(resultVarsContainer);
        }
    </script>

</body>

</html>
